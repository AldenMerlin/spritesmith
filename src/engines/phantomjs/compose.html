<!DOCTYPE html>
<html>
  <head>
    <title>Compose images</title>
    <script src="nimble.min.js"></script>
  </head>
  <body>
    <canvas id="canvas"></canvas>
    <script>
      // Grab the canvas and its context
      var canvas = document.getElementById('canvas'),
          context = canvas.getContext('2d');

      //  // Append our images to the canvas
      // var img1 = new Image();
      // img1.src = '../../src-test/test_sprites/sprite1.png';
      // img1.onload = function () {
      //   context.drawImage(img1, 0, 0);
      //   console.log(canvas.toDataURL('image/png'));
      // };

      // http://localhost:3000/src/engines/phantomjs/compose.html?{%22width%22:100,%22height%22:300,%22images%22:[{%22img%22:{%22height%22:50,%22width%22:50,%22_filepath%22:%22/home/todd/github/spritesmith/src-test/test_sprites/sprite1.png%22,%22_urlpath%22:%22../../../src-test/test_sprites/sprite1.png%22},%22x%22:0,%22y%22:0},{%22img%22:{%22height%22:50,%22width%22:50,%22_filepath%22:%22/home/todd/github/spritesmith/src-test/test_sprites/sprite2.jpg%22,%22_urlpath%22:%22../../../src-test/test_sprites/sprite2.jpg%22},%22x%22:0,%22y%22:50},{%22img%22:{%22height%22:200,%22width%22:100,%22_filepath%22:%22/home/todd/github/spritesmith/src-test/test_sprites/sprite3.png%22,%22_urlpath%22:%22../../../src-test/test_sprites/sprite3.png%22},%22x%22:0,%22y%22:100}],%22options%22:{}}

      // Grab the arguments
      var encodedArg = location.search.slice(1),
          arg = decodeURIComponent(encodedArg),
          params = JSON.parse(arg);

      // Set the canvas dimensions
      canvas.width = params.width;
      canvas.height = params.height;

      // Load the images in parallel
      var imageObjs = params.images;
      _.each(imageObjs, function (imageObj, cb) {
        // Create an image and specify the source
        var img = new Image();
        img.src = imageObj.img._urlpath;

        // Save the image for later
        imageObj._img = img;

        // Once the image loads, callback with it
        img.onload = function () {
          cb(null, img);
        };

        // If there is an error, callback with it
        img.onerror = function (err) {
          cb(err);
        };
      }, function imagesLoaded (err) {
        // If there was an error, throw it
        if (err) {
          console.error('Error loading image ', err);
          throw err;
        }

        // Draw the images on the canvas
        imageObjs.forEach(function drawImage (img) {
          context.drawImage(img._img, img.x, img.y);
        });

        // Capture the data url and save it for later
        var retStr = canvas.toDataURL('image/png');
        window.retStr = retStr;
      });
    </script>
  </body>
</html>